---
title: "Data Analysis FAIRness of Dental Research Data"
author: 'Uribe, Sofi-Mahmudi, Raittio, Maldupa and Vilne'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    code_folding: hide
  pdf_document:
    toc: yes
---
# General options
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE, out.width="75%")
# Use include=TRUE for the chunks to be displayed
```

# Packages

```{r}
# if not installed, install 
# install.packages("pacman")
# library(pacman)

pacman::p_load(tidyverse, # for data wrangling and visualizations 
               janitor,   # for data cleaning and tables
               here,      # for files handling
               gtsummary, # for tables
               visdat,    # for the NAs
               DataExplorer, # for EDA
               labelled,  # change labels
               dataMaid   # for the codebook
               )
```

```{r}
theme_set(theme_minimal())
```

```{r}
here::here()
```


# Datasets

```{r}
open_data_all <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_yrHOCcgEu2_VHvxgvQnJaXc1McdyoiCyzUqNNDfBc_9TBHtRNtl6LbM3yQEd8IGElVjqA_llGEto/pub?gid=537877323&single=true&output=csv")
```
Store local raw copy

```{r}
write.csv(df,here("fairness_dental_research_raw_data,csv"))
```



Select some columns for the analysis

```{r}
df <- open_data_all %>%
  select(
    doi_publication,
    title,
    journalTitle,
    pubYear,
    pubType,
    isOpenAccess,
    citedByCount,
    is_open_data,
    open_data_category,
    is_open_code,
    true_open_data,
    study_type,
    dataset_type,
    FAIR_level:FsF_R1.3_02D
  )
```

add index number 
```{r}
df <- df %>% 
  rowid_to_column("id")
```


```{r}
names(df)
```
```{r}
glimpse(df)
```
Replace all the TRUE and FALSE for YES/NO

```{r}
# convert all logical to chr

df <- df %>%
  mutate_if(is.logical, as.character) 
  
```


Remove the open_data_all
```{r}
rm(open_data_all)
```

## Summary


```{r}
summary(df)
```

## Labelling variables

```{r}
labelled::var_label(df$id) <- "ID of the publication"
labelled::var_label(df$title) <- "Publication title"
labelled::var_label(df$journalTitle) <- "Journal"
labelled::var_label(df$pubYear) <- "Pub Year"
labelled::var_label(df$pubType) <- "Pub Type"
labelled::var_label(df$isOpenAccess) <- "Open access pub"
labelled::var_label(df$citedByCount) <- "Citations"
labelled::var_label(df$is_open_data) <- "Open data"
labelled::var_label(df$open_data_category) <- "Open data cat"
labelled::var_label(df$is_open_code) <- "Open code"
labelled::var_label(df$true_open_data) <- "Open data*"
labelled::var_label(df$study_type) <- "Study type"
labelled::var_label(df$dataset_type) <- "Dataset type"
labelled::var_label(df$FAIR_level) <- "FAIR Level"
labelled::var_label(df$FAIRness) <- "FAIR Score"
labelled::var_label(df$Findability) <- "Findability"
labelled::var_label(df$Accesibility) <- "Accesibility"
labelled::var_label(df$Interoperability) <- "Interoperability"
labelled::var_label(df$Reusability) <- "Reusability"
labelled::var_label(df$Findability_level) <- "Findability Level"
labelled::var_label(df$Accesibility_level) <- "Accesibility Level"
labelled::var_label(df$Interoperability_level) <- "Interoperability Level"
labelled::var_label(df$Reusability_level) <- "Reusability Level"

## FAIR Items

labelled::var_label(df$'FsF_F1_01D') <- "F1-01D - Data is assigned a globally unique identifier"
labelled::var_label(df$'FsF_F1_02D') <- "F1-02D - Data is assigned a persistent identifier"
labelled::var_label(df$'FsF_F2_01M') <- "F2-01M - Metadata includes descriptive core elements (creator title data identifier publisher summary and keywords) to support data findability"
labelled::var_label(df$'FsF_F3_01M') <- "F3-01M - Metadata includes the identifier of the data it describes"
labelled::var_label(df$'FsF_F4_01M') <- "F4-01M - Metadata is offered in such a way that it can be retrieved"
labelled::var_label(df$'FsF_A1_01M') <- "A1-01M - Metadata contains access level and access conditions of the data"
labelled::var_label(df$'FsF_A1_03D') <- "A1-03D - Data is accessible through a standardized communication protocol"
labelled::var_label(df$'FsF_A1_02M') <- "A1-02M - Metadata is accessible through a standardized communication protocol"
labelled::var_label(df$'FsF_I1_01M') <- "I1-01M - Metadata is represented using a formal knowledge representation language"
labelled::var_label(df$'FsF_I1_02M') <- "I1-02M - Metadata uses semantic resources"
labelled::var_label(df$'FsF_I3_01M') <- "I3-01M - Metadata includes links between the data and its related entities"
labelled::var_label(df$'FsF_R1_01MD') <- "R1-01MD - Metadata specifies the content of the data"
labelled::var_label(df$'FsF_R1.1_01M') <- "R1.1-01M - Metadata includes license information under which data can be reused"
labelled::var_label(df$'FsF_R1.2_01M') <- "R1.2-01M - Metadata includes provenance information about data creation or generation"
labelled::var_label(df$'FsF_R1.3_01M') <- "R1.3-01M - Metadata follows a standard recommended by the target research community of the data"
labelled::var_label(df$'FsF_R1.3_02D') <- "R1.3-02D - Data is available in a file format recommended by the target research community"
```


## Recode variables

```{r}
df <- df %>% 
  relocate(is_open_data, .after = open_data_category)

```

```{r}
df <- df %>% 
  # reshape for easy handling
  pivot_longer(cols = is_open_data:true_open_data, 
               names_to = "openess", 
               values_to = "openess_values") %>% 
  # select(openess, openess_values) %>%  # just for test
  # change the values
  mutate(openess_values = case_when(
    openess_values == "TRUE" ~ "Yes", 
    TRUE ~ "No"
  )) %>% 
  # reshape to the original form
  pivot_wider(names_from = openess, 
              values_from = openess_values)
```

Change open access values

```{r}
df <- df %>% 
  mutate(isOpenAccess = case_when(
    isOpenAccess == "Y" ~ "Yes", 
    TRUE ~ "No"
  ))
```


Relevel variables

```{r}
df <- df %>% 
  pivot_longer(ends_with("_level"), 
               names_to = "var_level", 
               values_to = "var_values") %>% 
  mutate(var_values = fct_relevel(var_values, "incomplete", "initial", "moderate", "advanced")) %>% 
  pivot_wider(names_from = var_level, 
              values_from = var_values)
```



# EDA
## all data

### All articles
```{r}
df %>%
  mutate(journalTitle = fct_lump_prop(journalTitle, p = 0.03,
                                      other_level = "Other")) %>%
  group_by(journalTitle, true_open_data) %>%
  count(sort = T) %>%
  pivot_wider(names_from = true_open_data,
              values_from = n)
  
```

### Articles with data

```{r}
df %>% 
  tabyl(isOpenAccess, is_open_data) %>% 
  adorn_totals(where = c("row", "col"))
```


```{r}
df %>%
  filter(true_open_data == "Yes") %>% 
  # Use negative values to collapse the most common
  # the 25%
  mutate(journalTitle = fct_lump(journalTitle, other_level = "Other", prop = .025)) %>%
  group_by(journalTitle) %>%
  
  count(sort = T) 
```



## General

### Table 1

Subset some columns

```{r}
df %>% 
  select(-c(id, 
            doi_publication, 
            title, 
            pubType,
            study_type, 
            dataset_type, 
            open_data_category, 
            FAIR_level:FsF_R1.3_02D
            )) %>% 
  gtsummary::tbl_summary(by = isOpenAccess)
```

## Table 2

```{r}
df %>%
  select(journalTitle, true_open_data) %>% 
  gtsummary::tbl_summary(by = true_open_data, 
                         sort = all_categorical() ~ "frequency")
  
```


Check the journals without open data

```{r}
df %>% 
  filter(true_open_data != "Yes") %>% 
  select(journalTitle, true_open_data) %>% 
  gtsummary::tbl_summary(by = true_open_data, 
                         sort = all_categorical() ~ "frequency")
```



Chek if all the papers with FAIRness level has all the data
```{r}
df %>% 
  filter(!is.na(FAIRness)) %>% 
  plot_missing()
```
Check the discrete variables
```{r}
df %>% 
  select(journalTitle:FAIR_level) %>% 
   select(-c(pubType, open_data_category)) %>%  
  DataExplorer::plot_bar()
```

For the open data papers

```{r}
df %>% 
  filter(true_open_data == "Yes") %>% 
  select(journalTitle:FAIR_level) %>% 
  select(-c(pubType, open_data_category)) %>% 
  DataExplorer::plot_bar()
```


## How many papers do we have?
```{r}
n_distinct(df$title)
```


## How many are open access and how many are not?

Total papers
```{r}
dim(df)
```

## By open access status
```{r}
df %>% 
  janitor::tabyl(isOpenAccess) %>% 
  janitor::adorn_pct_formatting() %>% 
  adorn_totals(where = "row")
```
## How many have open data according to the package?

```{r}
df %>% 
  tabyl(isOpenAccess) %>%  
  janitor::adorn_pct_formatting() %>% 
  adorn_totals(where = "row") 
  
```
## Cross tabulation open access vs open data 

```{r}
df %>% 
  filter(isOpenAccess == "Yes") %>% 
  tabyl(isOpenAccess, is_open_data) %>%  
  adorn_totals(where = c("row", "col")) 
```
```{r}
df %>% 
  filter(isOpenAccess == "No") %>% 
  tabyl(isOpenAccess, is_open_data) %>%  
  adorn_totals(where = c("row", "col")) 
```

## Open data vs true open data in open access

```{r}
df %>% 
  filter(isOpenAccess == "Yes") %>% 
  tabyl(true_open_data, is_open_data)
```
Check with https://www.medcalc.org/calc/diagnostic_test.php

## Hoy many journals?

```{r}
df %>%
  group_by(isOpenAccess) %>%
  summarise(count = n_distinct(journalTitle))

```


## how many journal open access y non open access

```{r}
df %>% 
  select(journalTitle, isOpenAccess) %>% 
  gtsummary::tbl_summary(by = isOpenAccess, 
                         sort = all_categorical() ~ "frequency")
  
```
## Table 2  Availability of open data by journal and year
```{r}
df %>% 
  mutate(Journal = fct_lump_prop(journalTitle, p = .01)) %>% 
  select(Journal, true_open_data, pubYear) %>% 
  gtsummary::tbl_summary(by = true_open_data, 
                         sort = all_categorical() ~ "frequency")
```



# FAIRness

```{r}
summary(df$FAIRness)
```
```{r}
df %>% 
  tabyl(FAIRness, isOpenAccess) %>% 
  adorn_totals(where = "col")
  group_by(FAIRness, isOpenAccess) %>% 
  count() %>% 
  # summarise(n = n(), mean = mean(FAIRness)) %>% 
  pivot_wider(names_from = isOpenAccess, 
              values_from = n)
  
  
```


```{r}
df %>% 
  filter(true_open_data == "Yes") %>% 
  ggplot(aes(x = FAIRness)) +
  geom_histogram(bins = 10)
```
## FIG 1 FAIRness by journal

```{r}
df %>% 
  filter(true_open_data == "Yes") %>% 
  ggplot(aes(x = fct_reorder(journalTitle, FAIRness), 
             color = pubYear, 
             y = FAIRness 
             )) +
  geom_jitter(alpha = .5) +
  coord_flip() +
  ylim(0, 100) +
  labs(title = "FAIRness level by journal", 
       x = "Journal", 
       y = "FAIRness level (%)", 
       color = "Year")
```
Are differences by journal or year? 

```{r}
df %>% 
  filter(true_open_data == "Yes") %>% 
  mutate(Journal = fct_lump(journalTitle, n = 3)) %>% 
  with(glm(FAIRness ~ Journal + pubYear)) %>% 
  gtsummary::tbl_regression(exponentiate = T  )
```


## Figure 2 FAIRness by year
 
```{r}
df %>%
  mutate(id = "a") %>%
  filter(true_open_data == "Yes") %>%
  ggplot(aes(
    x = as.factor(pubYear),
    y = FAIRness,
    group = id
  )) +
  
  
  geom_point(position = position_jitter(width = .2), alpha = .3) +
  stat_summary(fun.y = mean, na.rm = TRUE,
               geom = "point", color = "dodgerblue", 
               size = 4, shape = "diamond") +
  stat_summary(fun.data = mean_cl_normal, na.rm =TRUE, 
               geom = "errorbar", width = .2, color = "dodgerblue") +
  stat_summary(fun.y = mean, na.rm = TRUE, aes(group = 1),
               geom = "line", color = "dodgerblue", 
               size = .75, shape = "diamond") +
    labs(title = "FAIRness level of dental research data by year",
       y = "FAIRness level (%)",
       x = "Year") +
  ylim(0, 100)
  
  

```



## With FAIRness assessment

### Publications by year by journal with open data

```{r}
df %>%
  filter(true_open_data == "Yes") %>%
  mutate(Journal = fct_lump(journalTitle, n = 6)) %>%
  group_by(Journal, pubYear) %>%
  summarise(n = n()) %>%
  ggplot(aes(
    x = pubYear,
    shape = Journal,
    color = Journal,
    group = Journal,
    y = n
  )) +
  geom_jitter(alpha = 0.8) +
  geom_line() +
  scale_shape_manual(values = 0:8) +
  scale_y_log10()
  pivot_wider(names_from = pubYear, values_from = n )
```

```{r}
df %>% 
  filter(true_open_data == "Yes") %>% 
  filter(!is.na(FAIRness)) %>% 
  mutate(Journal = fct_lump(journalTitle, n = 6)) %>%
  
  group_by(Journal, pubYear) %>% 
  summarise(FAIRness_mean = mean(FAIRness, na.rm = T)) %>% 
  mutate_if(is.numeric, format, 1) %>% 
  pivot_wider(names_from = pubYear, values_from = FAIRness_mean ) 
  
```

## Analysis by FAIRness items

```{r}
df %>% 
  filter(true_open_data == "Yes") %>% 
  filter(!is.na(FAIRness)) %>% 
  mutate(Journal = fct_lump(journalTitle, n = 6)) %>%
  select(Journal, pubYear, Findability:Reusability ) %>% 
  
  pivot_longer(Findability:Reusability, 
               names_to = "FAIR_item", 
               values_to = "FAIR_values") %>% 
  mutate(FAIR_item = fct_relevel(FAIR_item, "Findability", 
                                 "Accesibility", 
                                 "Interoperability",
                                 "Reusability")) %>% 
  
  ggplot(aes(x = FAIR_item, 
             y = FAIR_values)) + 
  geom_boxplot(width = .5, color = "dodgerblue") +
  geom_jitter(alpha = .1, color = "Grey 20") +
  labs(title = "FAIR level by domain", 
       x = "Domain", 
       y = "FAIR value")
  
```


## Extras

## Open access by year

```{r}
df %>% 
  filter(pubYear < 2022) %>% 
  group_by(pubYear, isOpenAccess) %>% 
  count() %>% 
  ggplot(aes(x = pubYear,
             group = isOpenAccess, 
             color = isOpenAccess, 
             y = n)) + 
  geom_line() + 
  scale_color_manual(values=c('red','green'))
```
### open data by year

```{r}
df %>% 
  filter(pubYear < 2022) %>% 
  group_by(pubYear, true_open_data) %>% 
  count() %>% 
  ggplot(aes(x = pubYear,
             group = true_open_data, 
             color = true_open_data, 
             y = n)) + 
  geom_line() + 
  scale_color_manual(values=c('red','green'))
```

### Open access has more citations per year?

```{r}
df %>% 
  group_by(pubYear, isOpenAccess) %>% 
  summarise(mean = mean(citedByCount)) %>%  
  ggplot(aes(x = pubYear, 
             y = mean, 
             group = isOpenAccess,  
             color = isOpenAccess)) + 
  geom_line()
```



### Open data has more citations per year?
```{r}
df %>% 
  group_by(pubYear, true_open_data) %>% 
  summarise(mean = mean(citedByCount)) %>%  
  ggplot(aes(x = pubYear, 
             y = mean, 
             group = true_open_data,  
             color = true_open_data)) + 
  geom_line()
```
Let's check

```{r}
glm(citedByCount ~  pubYear +  true_open_data + isOpenAccess + true_open_data * isOpenAccess, 
    data = df) %>% 
  gtsummary::tbl_regression(exponentiate = T)
```



# Codebook

(run only once at the end of the analysis)
```{r}
# open_data_all %>% 
#  dataMaid::makeCodebook()


```

```{r}
# sessionInfo() 
```


